<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(pageTitle='Nueva cita', content=~{::content})}"
      th:remove="tag">

<section th:fragment="content">

  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">

      <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="h4 mb-0">Nueva cita</h1>
        <a class="btn btn-outline-secondary btn-sm" th:href="@{/cliente}">Volver</a>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body p-4">

          <!-- Error disponibilidad (backend) -->
          <div class="alert alert-danger mb-3"
               th:if="${availabilityError}"
               th:text="${availabilityError}">
          </div>

          <!-- Aviso si no hay vehículos -->
          <div class="alert alert-warning mb-3"
               th:if="${vehicles != null and #lists.isEmpty(vehicles)}">
            No tienes vehículos registrados. Añade uno antes de reservar una cita.
            <a class="alert-link ms-1" th:href="@{/cliente/vehiculos/nuevo}">Crear vehículo</a>
          </div>

          <form th:action="@{/cliente/citas}" th:object="${appointment}" method="post" novalidate>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- Vehículo -->
            <div class="mb-3">
              <label class="form-label" for="vehicleId">Vehículo</label>
              <select class="form-select"
                      th:field="*{vehicleId}"
                      id="vehicleId"
                      required
                      th:disabled="${vehicles != null and #lists.isEmpty(vehicles)}">
                <option value="" selected disabled>Selecciona un vehículo…</option>

                <option th:each="v : ${vehicles}"
                        th:value="${v.idVehicle}"
                        th:text="${v.matricula + ' — ' + v.marca + ' ' + v.modelo}">
                </option>
              </select>

              <div class="text-danger small mt-1"
                   th:if="${#fields.hasErrors('vehicleId')}"
                   th:errors="*{vehicleId}">
              </div>
            </div>

            <!-- Servicio -->
            <div class="mb-3">
              <label class="form-label" for="serviceId">Servicio</label>
              <select class="form-select"
                      th:field="*{serviceId}"
                      id="serviceId"
                      required>
                <option value="" selected disabled>Selecciona un servicio…</option>

                <option th:each="s : ${services}"
                        th:value="${s.id}"
                        th:text="${s.nombre + ' (' + s.minutosEstimados + ' min)'}">
                </option>
              </select>

              <div class="text-danger small mt-1"
                   th:if="${#fields.hasErrors('serviceId')}"
                   th:errors="*{serviceId}">
              </div>

              <div class="form-text">La duración se calcula automáticamente según el servicio.</div>
            </div>

            <!-- Fecha / Hora -->
            <div class="mb-3">
              <label class="form-label" for="startDateTime">Fecha y hora</label>
              <input type="datetime-local"
                     class="form-control"
                     th:field="*{startDateTime}"
                     id="startDateTime"
                     required />

              <div class="text-danger small mt-1"
                   th:if="${#fields.hasErrors('startDateTime')}"
                   th:errors="*{startDateTime}">
              </div>

              <div class="form-text">El sistema validará la disponibilidad antes de guardar.</div>
            </div>

            <!-- (Opcional) Disponibilidad en vivo -->
            <div class="mb-3">
              <div id="availabilityBox"
                   class="alert d-none mb-0"
                   role="alert"
                   data-availability-url="/api/availability">
              </div>
              <div class="form-text mt-2">
                (Opcional) Si existe <code>/api/availability</code>, verás aquí si la franja está libre.
              </div>
            </div>

            <!-- Acciones -->
            <div class="d-grid d-sm-flex gap-2 justify-content-sm-end mt-4">
              <a class="btn btn-outline-secondary" th:href="@{/cliente}">Cancelar</a>

              <button class="btn btn-primary"
                      type="submit"
                      th:disabled="${vehicles != null and #lists.isEmpty(vehicles)}">
                Reservar cita
              </button>
            </div>

          </form>

        </div>
      </div>

    </div>
  </div>

</section>
</html>
