<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Backoffice · Detalle cita')"></head>

<body>

<div th:replace="fragments/navbar :: navbar"></div>

<main class="container my-4">

  <!-- Mensajes -->
  <div th:if="${ok}" class="alert alert-success mb-3" th:text="${ok}"></div>
  <div th:if="${error}" class="alert alert-danger mb-3" th:text="${error}"></div>

  <!-- Encabezado -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="me-2">
      <h1 class="h3 mb-1">Detalle de cita</h1>
      <div class="text-muted small">
        ID:
        <span class="fw-semibold" th:text="${appt.id}">1</span>
        <span class="mx-2">·</span>
        Fecha:
        <span class="fw-semibold" th:text="${#temporals.format(appt.inicio, 'yyyy-MM-dd')}">2026-02-02</span>
      </div>
    </div>

    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">
      <a class="btn btn-outline-secondary tt-btn-mobile" th:href="@{/backoffice/agenda}">Volver a agenda</a>
      <a class="btn btn-outline-dark tt-btn-mobile" th:href="@{/backoffice}">Dashboard</a>
    </div>
  </div>

  <div class="row g-3">

    <!-- Columna izquierda: resumen -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Resumen</div>

          <span class="badge"
                th:classappend="${
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).PENDIENTE  ? ' text-bg-warning' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).CONFIRMADA ? ' text-bg-primary' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).EN_CURSO   ? ' text-bg-info' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).FINALIZADA ? ' text-bg-success' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).CANCELADA  ? ' text-bg-danger' :
                  ' text-bg-secondary'
                }"
                th:text="${#strings.replace(appt.estado.name(), '_', ' ')}">
            PENDIENTE
          </span>
        </div>

        <div class="card-body">

          <div class="mb-3">
            <div class="text-muted small mb-1">Horario</div>
            <div class="fw-semibold tt-nowrap">
              <span th:text="${#temporals.format(appt.inicio, 'HH:mm')}">10:30</span>
              <span class="text-muted">→</span>
              <span th:text="${#temporals.format(appt.fin, 'HH:mm')}">11:00</span>
            </div>
            <div class="small text-muted">
              <span th:text="${#temporals.format(appt.inicio, 'dd/MM/yyyy')}">02/02/2026</span>
            </div>
          </div>

          <div class="mb-2">
            <div class="text-muted small mb-1">Mecánico asignado</div>

            <div th:if="${appt.employeeAsignado != null}">
              <div class="fw-semibold">
                <span th:text="${appt.employeeAsignado.user != null ? appt.employeeAsignado.user.nombre : 'Empleado'}">Mecánico</span>
                <span class="text-muted"
                      th:if="${appt.employeeAsignado.user != null && appt.employeeAsignado.user.apellidos != null}"
                      th:text="${' ' + appt.employeeAsignado.user.apellidos}">
                  Apellidos
                </span>
              </div>
              <div class="small text-muted"
                   th:text="${appt.employeeAsignado.user != null ? appt.employeeAsignado.user.email : ''}">
                mecanico@tt2025.local
              </div>
            </div>

            <div th:if="${appt.employeeAsignado == null}">
              <span class="badge text-bg-secondary">SIN ASIGNAR</span>
            </div>
          </div>

          <hr class="my-4"/>

          <div class="mb-0">
            <div class="text-muted small mb-1">Orden de trabajo</div>

            <div th:if="${wo != null}">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold">OT #<span th:text="${wo.id}">1</span></div>

                <!-- ✅ ESTADO OT EN MAYÚSCULAS + clases por estado -->
                <span class="badge"
                      th:classappend="${
                        wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).cerrada ? ' text-bg-success' :
                        wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).abierta ? ' text-bg-warning' :
                        wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).en_proceso ? ' text-bg-info' :
                        wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).espera_piezas ? ' text-bg-secondary' :
                        ' text-bg-dark'
                      }"
                      th:text="${#strings.toUpperCase(#strings.replace(wo.estado.name(), '_', ' '))}">
                  ABIERTA
                </span>
              </div>

              <a class="btn btn-outline-secondary btn-sm mt-2 w-100 tt-btn-mobile"
                 th:href="@{/backoffice/workorders/{id}(id=${wo.id})}">
                Ver OT
              </a>
            </div>

            <div th:if="${wo == null}">
              <div class="text-muted small">No hay OT asociada.</div>

              <form class="mt-2"
                    method="post"
                    th:action="@{/backoffice/citas/{id}/workorder(id=${appt.id})}">
                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <button type="submit" class="btn btn-primary btn-sm w-100 tt-btn-mobile">
                  Abrir OT
                </button>
              </form>
            </div>

          </div>

        </div>
      </div>
    </div>

    <!-- Columna derecha: datos -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0">
          <div class="fw-semibold">Datos</div>
        </div>

        <div class="card-body">

          <div class="mb-3">
            <div class="text-muted small mb-1">Servicio</div>
            <div class="fw-semibold" th:text="${appt.service != null ? appt.service.nombre : '-'}">Cambio de aceite</div>
            <div class="small text-muted" th:if="${appt.service != null}">
              <span class="me-2">Código:</span>
              <span th:text="${appt.service.codigo}">ACEITE</span>
              <span class="mx-2">·</span>
              <span th:text="${appt.service.minutosEstimados}">30</span> min
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-md-6">
              <div class="text-muted small mb-1">Vehículo</div>
              <div th:if="${appt.vehicle != null}">
                <div class="fw-semibold">
                  <span class="badge text-bg-secondary" th:text="${appt.vehicle.matricula}">1234ABC</span>
                </div>
                <div class="small text-muted">
                  <span th:text="${appt.vehicle.marca != null ? appt.vehicle.marca : '-'}">Seat</span>
                  <span th:text="${appt.vehicle.modelo != null ? ' ' + appt.vehicle.modelo : ''}"> Ibiza</span>
                </div>
              </div>
              <div th:if="${appt.vehicle == null}" class="text-muted">-</div>
            </div>

            <div class="col-12 col-md-6">
              <div class="text-muted small mb-1">Cliente</div>
              <div th:if="${appt.customer != null && appt.customer.user != null}">
                <div class="small text-muted"
                     th:if="${appt.customer.user.telefono != null}"
                     th:text="${appt.customer.user.telefono}">
                  600123123
                </div>
                <div class="fw-semibold"
                     th:text="${appt.customer.user.nombre + ' ' + appt.customer.user.apellidos}">
                  Nombre Apellidos
                </div>
                <div class="small text-muted"
                     th:text="${appt.customer.user.email}">
                  email@cliente.com
                </div>
              </div>
              <div th:if="${appt.customer == null || appt.customer.user == null}" class="text-muted">-</div>
            </div>
          </div>

          <hr class="my-4"/>

          <div class="alert alert-warning"
               th:if="${appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).EN_CURSO and !canFinalize}">
            Para finalizar la cita, la orden de trabajo debe estar <strong>CERRADA</strong>.
          </div>

          <!-- ✅ Acciones: botones alineados y separados del texto -->
          <div class="row g-3 align-items-stretch">

            <!-- Cambiar estado -->
            <div class="col-12 col-xl-6 d-flex">
              <form class="d-flex flex-column flex-grow-1 h-100"
                    method="post"
                    th:action="@{/backoffice/citas/{id}/estado(id=${appt.id})}">

                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div>
                  <label for="newStatus" class="form-label mb-1">Cambiar estado</label>
                  <select id="newStatus" name="newStatus" class="form-select tt-mobile-full">
                    <option th:each="s : ${T(es.prw.features.appointments.domain.AppointmentStatus).values()}"
                            th:if="${s != T(es.prw.features.appointments.domain.AppointmentStatus).FINALIZADA
                                    or canFinalize
                                    or appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).FINALIZADA}"
                            th:value="${s}"
                            th:text="${#strings.replace(s.name(), '_', ' ')}"
                            th:selected="${s == appt.estado}">
                      PENDIENTE
                    </option>
                  </select>

                  <!-- separación real -->
                  <div class="form-text mb-3">
                    Reglas: cancelar / finalizar solo desde EN CURSO y con OT cerrada.
                  </div>
                </div>

                <button type="submit" class="btn btn-primary tt-btn-mobile mt-auto">
                  Guardar
                </button>
              </form>
            </div>

            <!-- Asignar mecánico -->
            <div class="col-12 col-xl-6 d-flex">
              <form class="d-flex flex-column flex-grow-1 h-100"
                    method="post"
                    th:action="@{/backoffice/citas/{id}/asignar(id=${appt.id})}">

                <input type="hidden" th:if="${_csrf != null}"
                       th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div>
                  <label for="mechanicId" class="form-label mb-1">Asignar mecánico</label>
                  <select id="mechanicId" name="mechanicId" class="form-select tt-mobile-full">
                    <option value="" disabled th:selected="${appt.employeeAsignado == null}">Selecciona...</option>
                    <option th:each="m : ${mechanics}"
                            th:value="${m.id}"
                            th:selected="${appt.employeeAsignado != null and m.id == appt.employeeAsignado.id}"
                            th:text="${m.user != null ? (m.user.nombre + ' ' + m.user.apellidos) : ('Empleado #' + m.id)}">
                      Mecánico
                    </option>
                  </select>

                  <!-- separación real -->
                  <div class="form-text mb-3">Solo mecánicos activos.</div>
                </div>

                <button type="submit" class="btn btn-outline-secondary tt-btn-mobile mt-auto">
                  Asignar
                </button>
              </form>
            </div>

          </div>

        </div>
      </div>
    </div>

  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
