<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Backoffice · Detalle cita')"></head>

<body>

<div th:replace="fragments/navbar :: navbar"></div>

<main class="container my-4">

  <!-- Mensajes -->
  <div th:if="${ok}" class="alert alert-success mb-3" th:text="${ok}"></div>
  <div th:if="${error}" class="alert alert-danger mb-3" th:text="${error}"></div>

  <!-- Encabezado -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h3 mb-1">Detalle de cita</h1>
      <div class="text-muted small">
        ID:
        <span class="fw-semibold" th:text="${appt.id}">1</span>
        <span class="mx-2">·</span>
        Fecha:
        <span class="fw-semibold" th:text="${#temporals.format(appt.inicio, 'yyyy-MM-dd')}">2026-02-02</span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" th:href="@{/backoffice/agenda}">Volver a agenda</a>
      <a class="btn btn-outline-dark" th:href="@{/backoffice}">Dashboard</a>
    </div>
  </div>

  <div class="row g-3">

    <!-- Columna izquierda: resumen -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Resumen</div>

          <span class="badge"
                th:classappend="${
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).PENDIENTE  ? ' text-bg-warning' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).CONFIRMADA ? ' text-bg-primary' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).EN_CURSO   ? ' text-bg-info' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).FINALIZADA ? ' text-bg-success' :
                  appt.estado == T(es.prw.features.appointments.domain.AppointmentStatus).CANCELADA  ? ' text-bg-danger' :
                  ' text-bg-secondary'
                }"
                th:text="${appt.estado}">
            PENDIENTE
          </span>
        </div>

        <div class="card-body">

          <!-- Hora -->
          <div class="mb-3">
            <div class="text-muted small mb-1">Horario</div>
            <div class="fw-semibold">
              <span th:text="${#temporals.format(appt.inicio, 'HH:mm')}">10:30</span>
              <span class="text-muted">→</span>
              <span th:text="${#temporals.format(appt.fin, 'HH:mm')}">11:00</span>
            </div>
            <div class="small text-muted">
              <span th:text="${#temporals.format(appt.inicio, 'dd/MM/yyyy')}">02/02/2026</span>
            </div>
          </div>

          <!-- Mecánico asignado -->
          <div class="mb-2">
            <div class="text-muted small mb-1">Mecánico asignado</div>

            <div th:if="${appt.employeeAsignado != null}">
              <div class="fw-semibold">
                <span th:text="${appt.employeeAsignado.user != null ? appt.employeeAsignado.user.nombre : 'Empleado'}">Mecánico</span>
                <span class="text-muted"
                      th:if="${appt.employeeAsignado.user != null && appt.employeeAsignado.user.apellidos != null}"
                      th:text="${' ' + appt.employeeAsignado.user.apellidos}">
                  Apellidos
                </span>
              </div>
              <div class="small text-muted"
                   th:text="${appt.employeeAsignado.user != null ? appt.employeeAsignado.user.email : ''}">
                mecanico@tt2025.local
              </div>
            </div>

            <div th:if="${appt.employeeAsignado == null}">
              <span class="badge text-bg-secondary">SIN ASIGNAR</span>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Columna derecha: datos -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0">
          <div class="fw-semibold">Datos</div>
        </div>

        <div class="card-body">

          <!-- Servicio -->
          <div class="mb-3">
            <div class="text-muted small mb-1">Servicio</div>
            <div class="fw-semibold" th:text="${appt.service != null ? appt.service.nombre : '-'}">Cambio de aceite</div>
            <div class="small text-muted" th:if="${appt.service != null}">
              <span class="me-2">Código:</span>
              <span th:text="${appt.service.codigo}">ACEITE</span>
              <span class="mx-2">·</span>
              <span th:text="${appt.service.minutosEstimados}">30</span> min
            </div>
          </div>

          <div class="row g-3">

            <!-- Vehículo -->
            <div class="col-12 col-md-6">
              <div class="text-muted small mb-1">Vehículo</div>
              <div th:if="${appt.vehicle != null}">
                <div class="fw-semibold">
                  <span class="badge text-bg-secondary" th:text="${appt.vehicle.matricula}">1234ABC</span>
                </div>
                <div class="small text-muted">
                  <span th:text="${appt.vehicle.marca != null ? appt.vehicle.marca : '-'}">Seat</span>
                  <span th:text="${appt.vehicle.modelo != null ? ' ' + appt.vehicle.modelo : ''}"> Ibiza</span>
                </div>
              </div>
              <div th:if="${appt.vehicle == null}" class="text-muted">-</div>
            </div>

            <!-- Cliente -->
            <div class="col-12 col-md-6">
              <div class="text-muted small mb-1">Cliente</div>
              <div th:if="${appt.customer != null && appt.customer.user != null}">
				<div class="small text-muted"
				     th:if="${appt.customer.user.telefono != null}"
				     th:text="${appt.customer.user.telefono}">
				  600123123
				</div>
                <div class="fw-semibold"
                     th:text="${appt.customer.user.nombre + ' ' + appt.customer.user.apellidos}">
                  Nombre Apellidos
                </div>
                <div class="small text-muted"
                     th:text="${appt.customer.user.email}">
                  email@cliente.com
                </div>
              </div>
              <div th:if="${appt.customer == null || appt.customer.user == null}" class="text-muted">-</div>
            </div>

          </div>

          <hr class="my-4"/>

          <div class="d-flex flex-wrap gap-4">

            <!-- Acción: cambiar estado -->
            <form class="d-flex flex-wrap gap-2 align-items-end"
                  method="post"
                  th:action="@{/backoffice/citas/{id}/estado(id=${appt.id})}">

              <!-- CSRF -->
              <input type="hidden" th:if="${_csrf != null}"
                     th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

              <div>
                <label for="newStatus" class="form-label mb-1">Cambiar estado</label>
                <select id="newStatus" name="newStatus" class="form-select">
                  <option th:each="s : ${T(es.prw.features.appointments.domain.AppointmentStatus).values()}"
                          th:value="${s}"
                          th:text="${s}"
                          th:selected="${s == appt.estado}">
                    PENDIENTE
                  </option>
                </select>
                <div class="form-text">Reglas: cancelada / finalizar solo desde EN_CURSO.</div>
              </div>

              <button type="submit" class="btn btn-primary">Guardar</button>
            </form>

            <!-- Acción: asignar mecánico -->
            <form class="d-flex flex-wrap gap-2 align-items-end"
                  method="post"
                  th:action="@{/backoffice/citas/{id}/asignar(id=${appt.id})}">

              <!-- CSRF -->
              <input type="hidden" th:if="${_csrf != null}"
                     th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

              <div>
                <label for="mechanicId" class="form-label mb-1">Asignar mecánico</label>
                <select id="mechanicId" name="mechanicId" class="form-select">
                  <option value="" disabled th:selected="${appt.employeeAsignado == null}">Selecciona...</option>

                  <option th:each="m : ${mechanics}"
                          th:value="${m.id}"
                          th:selected="${appt.employeeAsignado != null and m.id == appt.employeeAsignado.id}"
                          th:text="${m.user != null ? (m.user.nombre + ' ' + m.user.apellidos) : ('Empleado #' + m.id)}">
                    Mecánico
                  </option>
                </select>
                <div class="form-text">Solo mecánicos activos.</div>
              </div>

              <button type="submit" class="btn btn-outline-secondary">Asignar</button>
            </form>

          </div>

        </div>
      </div>
    </div>

  </div>

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
