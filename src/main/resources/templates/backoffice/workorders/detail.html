<!DOCTYPE html>
<html lang="es"
      xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: html(pageTitle='Backoffice · Orden de trabajo', content=~{::content})}"
      th:remove="tag">

<section th:fragment="content"
         th:with="
           isClosed=${wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).cerrada},
           isMechanic=${#authorization.expression('hasAnyAuthority(''MECANICO'',''ROLE_MECANICO'')')}
         ">

  <!-- Mensajes -->
  <div th:if="${ok}" class="alert alert-success mb-3" th:text="${ok}"></div>
  <div th:if="${error}" class="alert alert-danger mb-3" th:text="${error}"></div>

  <!-- Aviso MECÁNICO -->
  <div class="alert alert-info mb-3"
       th:if="${isMechanic}">
    Perfil <strong>MECÁNICO</strong>:
    puedes editar <strong>Diagnóstico</strong> y <strong>Observaciones</strong> en OTs abiertas.
    No tienes permisos para <strong>cerrar</strong> la OT ni <strong>gestionar piezas</strong>.
  </div>

  <!-- Encabezado -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div class="me-2">
      <h1 class="h3 mb-1">Orden de trabajo</h1>
      <div class="text-muted small" th:if="${wo != null}">
        ID OT:
        <span class="fw-semibold" th:text="${wo.id}">1</span>
        <span class="mx-2">·</span>
        Cita:
        <span class="fw-semibold" th:text="${wo.appointment != null ? wo.appointment.id : '-'}">22</span>
      </div>
    </div>

    <!-- Acciones cabecera -->
    <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">

      <!-- ✅ MECÁNICO: Volver a Órdenes -->
      <a class="btn btn-outline-secondary tt-btn-mobile"
         th:if="${isMechanic}"
         th:href="@{/backoffice/workorders}">
        Volver a Órdenes
      </a>

      <!-- ✅ RESTO: Volver a cita -->
      <a class="btn btn-outline-secondary tt-btn-mobile"
         th:if="${!isMechanic && wo != null && wo.appointment != null}"
         th:href="@{/backoffice/citas/{id}(id=${wo.appointment.id})}">
        Volver a cita
      </a>

      <!-- ✅ Dashboard SOLO si NO es mecánico -->
      <a class="btn btn-outline-dark tt-btn-mobile"
         th:if="${!isMechanic}"
         th:href="@{/backoffice}">
        Dashboard
      </a>

    </div>
  </div>

  <div class="row g-3">

    <!-- Columna izquierda: resumen OT -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm rounded-4 overflow-hidden border-0">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Resumen OT</div>

          <!-- Estado OT -->
          <span class="badge"
                th:classappend="${
                  wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).abierta        ? ' text-bg-warning' :
                  wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).en_proceso    ? ' text-bg-info' :
                  wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).espera_piezas ? ' text-bg-secondary' :
                  wo.estado == T(es.prw.features.workorders.domain.WorkOrderStatus).cerrada       ? ' text-bg-success' :
                  ' text-bg-dark'
                }"
                th:text="${#strings.toUpperCase(#strings.replace(wo.estado.name(), '_', ' '))}">
            CERRADA
          </span>
        </div>

        <div class="card-body">

          <!-- Cerrar OT (solo NO mecánico y solo si no cerrada) -->
          <div class="mb-3" th:if="${!isClosed && !isMechanic}">
            <form th:action="@{/backoffice/workorders/{id}/close(id=${wo.id})}" method="post"
                  onsubmit="return confirm('¿Cerrar la orden de trabajo? No se podrá editar después.');">

              <input type="hidden" th:if="${_csrf != null}"
                     th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

              <button type="submit" class="btn btn-danger tt-btn-mobile">
                Cerrar orden de trabajo
              </button>
            </form>

            <div class="form-text mt-2">
              Al cerrar la OT se bloquean notas y piezas.
            </div>
          </div>

          <!-- Aviso cerrada -->
          <div class="mb-3" th:if="${isClosed}">
            <div class="alert alert-success mb-0">
              Esta orden está <strong>CERRADA</strong>. No se permiten cambios.
            </div>
          </div>

          <!-- Aviso: mecánico no puede cerrar -->
          <div class="mb-3" th:if="${!isClosed && isMechanic}">
            <div class="alert alert-secondary mb-0">
              Esta OT está <strong>ABIERTA</strong>. Puedes editar diagnóstico/observaciones.
              <strong>No puedes cerrar</strong> la OT.
            </div>
          </div>

          <div class="mb-3">
            <div class="text-muted small mb-1">Apertura</div>
            <div class="fw-semibold"
                 th:text="${wo.openedAt != null ? #temporals.format(wo.openedAt, 'dd/MM/yyyy HH:mm') : '-'}">
              06/02/2026 10:30
            </div>
          </div>

          <div class="mb-0">
            <div class="text-muted small mb-1">Cierre</div>
            <div class="fw-semibold"
                 th:text="${wo.closedAt != null ? #temporals.format(wo.closedAt, 'dd/MM/yyyy HH:mm') : '-'}">
              -
            </div>
          </div>

          <hr class="my-4"/>

          <div th:if="${wo.appointment != null}">
            <div class="text-muted small mb-1">Horario cita</div>
            <div class="fw-semibold tt-nowrap">
              <span th:text="${#temporals.format(wo.appointment.inicio, 'HH:mm')}">10:30</span>
              <span class="text-muted">→</span>
              <span th:text="${#temporals.format(wo.appointment.fin, 'HH:mm')}">11:00</span>
            </div>
            <div class="small text-muted">
              <span th:text="${#temporals.format(wo.appointment.inicio, 'dd/MM/yyyy')}">06/02/2026</span>
            </div>

            <div class="mt-3">
              <div class="text-muted small mb-1">Estado cita</div>
              <span class="badge"
                    th:classappend="${
                      wo.appointment.estado == T(es.prw.features.appointments.domain.AppointmentStatus).PENDIENTE  ? ' text-bg-warning' :
                      wo.appointment.estado == T(es.prw.features.appointments.domain.AppointmentStatus).CONFIRMADA ? ' text-bg-primary' :
                      wo.appointment.estado == T(es.prw.features.appointments.domain.AppointmentStatus).EN_CURSO   ? ' text-bg-info' :
                      wo.appointment.estado == T(es.prw.features.appointments.domain.AppointmentStatus).FINALIZADA ? ' text-bg-success' :
                      wo.appointment.estado == T(es.prw.features.appointments.domain.AppointmentStatus).CANCELADA  ? ' text-bg-danger' :
                      ' text-bg-secondary'
                    }"
                    th:text="${#strings.toUpperCase(#strings.replace(wo.appointment.estado.name(), '_', ' '))}">
                EN CURSO
              </span>
            </div>
          </div>

          <div th:if="${wo.appointment == null}" class="text-muted small">
            Esta OT no tiene cita asociada.
          </div>

        </div>
      </div>
    </div>

    <!-- Columna derecha -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm rounded-4 overflow-hidden border-0">
        <div class="card-header bg-white border-0">
          <div class="fw-semibold">Datos y diagnóstico</div>
        </div>

        <div class="card-body">

          <!-- Datos cita -->
          <div th:if="${wo.appointment != null}">

            <div class="mb-3">
              <div class="text-muted small mb-1">Servicio</div>
              <div class="fw-semibold"
                   th:text="${wo.appointment.service != null ? wo.appointment.service.nombre : '-'}">
                Cambio de aceite
              </div>
              <div class="small text-muted" th:if="${wo.appointment.service != null}">
                <span class="me-2">Código:</span>
                <span th:text="${wo.appointment.service.codigo}">ACEITE</span>
                <span class="mx-2">·</span>
                <span th:text="${wo.appointment.service.minutosEstimados}">30</span> min
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="text-muted small mb-1">Vehículo</div>
                <div th:if="${wo.appointment.vehicle != null}">
                  <div class="fw-semibold">
                    <span class="badge text-bg-secondary"
                          th:text="${wo.appointment.vehicle.matricula}">1234ABC</span>
                  </div>
                  <div class="small text-muted">
                    <span th:text="${wo.appointment.vehicle.marca != null ? wo.appointment.vehicle.marca : '-'}">Seat</span>
                    <span th:text="${wo.appointment.vehicle.modelo != null ? ' ' + wo.appointment.vehicle.modelo : ''}">
                      Ibiza
                    </span>
                  </div>
                </div>
                <div th:if="${wo.appointment.vehicle == null}" class="text-muted">-</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="text-muted small mb-1">Cliente</div>
                <div th:if="${wo.appointment.customer != null && wo.appointment.customer.user != null}">
                  <div class="small text-muted" th:if="${wo.appointment.customer.user.telefono != null}"
                       th:text="${wo.appointment.customer.user.telefono}">
                    600123123
                  </div>

                  <div class="fw-semibold"
                       th:text="${wo.appointment.customer.user.nombre + ' ' + wo.appointment.customer.user.apellidos}">
                    Nombre Apellidos
                  </div>

                  <div class="small text-muted" th:text="${wo.appointment.customer.user.email}">
                    email@cliente.com
                  </div>
                </div>
                <div th:if="${wo.appointment.customer == null || wo.appointment.customer.user == null}" class="text-muted">-</div>
              </div>
            </div>

            <hr class="my-4"/>
          </div>

          <!-- Form diagnóstico (mecánico sí puede; cerrado no) -->
          <form method="post" th:action="@{/backoffice/workorders/{id}(id=${wo.id})}">
            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="mb-3">
              <div class="tt-form-row">
                <label for="diagnostico" class="form-label mb-0">Diagnóstico</label>
                <textarea id="diagnostico" name="diagnostico" rows="6"
                          class="form-control tt-mobile-full"
                          th:disabled="${isClosed}"
                          placeholder="Describe el diagnóstico..."
                          th:text="${wo.diagnostico}"></textarea>
                <div class="form-text">Información técnica del problema detectado.</div>
              </div>
            </div>

            <div class="mb-3">
              <div class="tt-form-row">
                <label for="observaciones" class="form-label mb-0">Observaciones</label>
                <textarea id="observaciones" name="observaciones" rows="6"
                          class="form-control tt-mobile-full"
                          th:disabled="${isClosed}"
                          placeholder="Notas adicionales, decisiones, recomendaciones..."
                          th:text="${wo.observaciones}"></textarea>
                <div class="form-text">Notas internas del taller.</div>
              </div>
            </div>

            <div class="d-grid gap-2 d-sm-flex">
              <button type="submit" class="btn btn-primary tt-btn-mobile" th:disabled="${isClosed}">
                Guardar
              </button>

              <!-- ✅ MECÁNICO: volver a órdenes -->
              <a class="btn btn-outline-secondary tt-btn-mobile"
                 th:if="${isMechanic}"
                 th:href="@{/backoffice/workorders}">
                Volver a Órdenes
              </a>

              <!-- ✅ RESTO: volver a cita -->
              <a class="btn btn-outline-secondary tt-btn-mobile"
                 th:if="${!isMechanic && wo.appointment != null}"
                 th:href="@{/backoffice/citas/{id}(id=${wo.appointment.id})}">
                Volver a cita
              </a>
            </div>

            <div class="alert alert-warning mt-3 mb-0" th:if="${isClosed}">
              OT CERRADA: el formulario está deshabilitado.
            </div>
          </form>

          <hr class="my-4">

          <h5 class="mb-3">Piezas usadas</h5>

          <!-- Aviso: piezas bloqueadas para mecánico -->
          <div class="alert alert-secondary mb-3"
               th:if="${isMechanic}">
            Gestión de piezas deshabilitada para el perfil <strong>MECÁNICO</strong>.
          </div>

          <!-- =========================================================
               PIEZAS: TARJETAS (móvil + tablet) <= 992px
               ========================================================= -->
          <div class="tt-show-cards-lg d-grid gap-2">

            <div th:if="${parts == null || #lists.isEmpty(parts)}" class="alert alert-info mb-0">
              No hay piezas registradas
            </div>

            <div class="card border-0 shadow-sm" th:each="p : ${parts}">
              <div class="card-body" th:with="sku=${partSku[p.partId]} ?: ('#' + p.partId)">

                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div>
                    <div class="fw-semibold tt-break" th:text="${sku}">SKU</div>
                    <div class="text-muted small tt-break" th:text="${p.notes != null ? p.notes : '—'}">Notas</div>
                  </div>

                  <div class="text-end">
                    <div class="small text-muted">Total</div>
                    <div class="fw-semibold tt-nowrap" th:text="${p.total}">0.00</div>
                  </div>
                </div>

                <hr class="my-3"/>

                <div class="row g-2 small">
                  <div class="col-4">
                    <div class="text-muted">Cant.</div>
                    <div class="tt-nowrap" th:text="${p.quantity}">1</div>
                  </div>
                  <div class="col-4">
                    <div class="text-muted">Precio</div>
                    <div class="tt-nowrap" th:text="${p.unitPrice}">0.00</div>
                  </div>
                  <div class="col-4">
                    <div class="text-muted">Total</div>
                    <div class="tt-nowrap" th:text="${p.total}">0.00</div>
                  </div>
                </div>

                <div class="d-grid mt-3">
                  <form th:action="@{/backoffice/workorders/{id}/parts/{pid}/delete(id=${wo.id},pid=${p.id})}"
                        method="post"
                        onsubmit="return confirm('¿Eliminar pieza?');">
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button class="btn btn-outline-danger tt-btn-mobile"
                            type="submit"
                            th:disabled="${isClosed || isMechanic}">
                      Eliminar pieza
                    </button>
                  </form>
                </div>

              </div>
            </div>

          </div>

          <!-- =========================================================
               PIEZAS: TABLA (escritorio) >= 993px
               ========================================================= -->
          <div class="tt-hide-cards-lg">

            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle mb-0">
                <thead class="table-light">
                <tr>
                  <th class="tt-nowrap">SKU</th>
                  <th class="tt-nowrap">Cantidad</th>
                  <th class="tt-nowrap">Precio unit.</th>
                  <th class="tt-nowrap">Total</th>
                  <th>Notas</th>
                  <th style="width: 80px;" class="tt-nowrap"></th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="p : ${parts}">
                  <td class="tt-break" th:text="${partSku[p.partId]} ?: ('#' + p.partId)">SKU</td>
                  <td class="tt-nowrap" th:text="${p.quantity}">1</td>
                  <td class="tt-nowrap" th:text="${p.unitPrice}">0.00</td>
                  <td class="tt-nowrap" th:text="${p.total}">0.00</td>
                  <td class="tt-break" th:text="${p.notes}">-</td>
                  <td>
                    <form th:action="@{/backoffice/workorders/{id}/parts/{pid}/delete(id=${wo.id},pid=${p.id})}"
                          method="post"
                          onsubmit="return confirm('¿Eliminar pieza?');">
                      <input type="hidden" th:if="${_csrf != null}"
                             th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                      <button class="btn btn-sm btn-outline-danger"
                              type="submit"
                              th:disabled="${isClosed || isMechanic}">
                        ✖
                      </button>
                    </form>
                  </td>
                </tr>

                <tr th:if="${parts == null || #lists.isEmpty(parts)}">
                  <td colspan="6" class="text-muted text-center">
                    No hay piezas registradas
                  </td>
                </tr>
                </tbody>
              </table>
            </div>

          </div>

          <!-- Añadir piezas (solo NO cerrada y NO mecánico) -->
          <form th:if="${!isClosed && !isMechanic}"
                th:action="@{/backoffice/workorders/{id}/parts(id=${wo.id})}"
                th:object="${newPart}"
                method="post" class="row g-2 mt-3">

            <input type="hidden" th:if="${_csrf != null}"
                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="col-12 col-md-5">
              <select id="partSelect" th:field="*{partId}" class="form-select tt-mobile-full" required>
                <option value="" disabled selected>Selecciona una pieza…</option>
                <option th:each="cp : ${catalogParts}"
                        th:value="${cp.id}"
                        th:text="${cp.nombre}"
                        th:attr="data-allows-decimal=${cp.allowsDecimal}">
                  Pieza
                </option>
              </select>
            </div>

            <div class="col-12 col-md-2">
              <input id="qtyInput" type="number" th:field="*{quantity}"
                     class="form-control tt-mobile-full"
                     placeholder="Cantidad" min="1" step="1" required>
            </div>

            <div class="col-12 col-md-3">
              <input type="text" th:field="*{notes}"
                     class="form-control tt-mobile-full"
                     placeholder="Notas (opcional)">
            </div>

            <div class="col-12 col-md-2 d-grid">
              <button class="btn btn-primary tt-btn-mobile" type="submit">Añadir</button>
            </div>

          </form>

          <!-- JS (solo afecta si existe el form) -->
          <script>
            (function () {
              const sel = document.getElementById('partSelect');
              const qty = document.getElementById('qtyInput');
              if (!sel || !qty) return;

              function refreshQtyRules() {
                const opt = sel.options[sel.selectedIndex];
                const allows = opt && opt.getAttribute('data-allows-decimal') === 'true';

                if (allows) {
                  qty.step = '0.1';
                  qty.min = '0.1';
                  qty.placeholder = 'Cantidad';
                } else {
                  qty.step = '1';
                  qty.min = '1';
                  qty.placeholder = 'Cantidad';
                  if (String(qty.value).includes('.')) qty.value = '';
                }
              }

              sel.addEventListener('change', refreshQtyRules);
              refreshQtyRules();
            })();
          </script>

        </div>
      </div>
    </div>

  </div>

</section>
</html>
